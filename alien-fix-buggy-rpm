#!/bin/sh -e
#
# Fix RPMs generated by alien that contain conflicting directories.
#
# Usage:  alian-fix-buggy-rpm RPM
#
# Where RPM is the path to an alien-generated RPM.
#

die()
{
    echo "$@" 1>&2
    exit 1
}

# $1 - Path to RPM
[ -f "$1" ] \
    || die "$1:  Not found."
ALIEN_RPM_DIR=$(cd "$(dirname "$1")"; pwd -P)
ALIEN_RPM="${ALIEN_RPM_DIR}/$(basename "$1")"


# Workspace
WORK=$(mktemp -d)
cleanup()
{
    rm -rf ${WORK}
}
trap cleanup EXIT


# Unpack the original RPM and find its directory
(cd ${WORK} && alien -r -g "${ALIEN_RPM}")
# TODO: This assumes only one directory was unpacked.
UNPACKED="${WORK}/$(cd ${WORK} && ls | head -1)"


# Relocate the spec so rpmbuild doesn't complain about it.
SPEC=$(find "${UNPACKED}" -name "*.spec")
mv "${SPEC}" "${WORK}/spec"
SPEC="${WORK}/spec"


# Clean out the spec's %files section and re-fill it with files from
# what was unpacked.
sed -i -e '/%files/q' "${SPEC}"

echo '%defattr(-,root,root,-)' >> "${SPEC}"

(cd "${UNPACKED}" && find . -type f) \
    | egrep -ve '\.spec$' \
    | sed -e 's|^.||; s/^/"/; s/$/"/' \
    >> "${SPEC}"


# Rebuild the RPM
RPMBUILD="${WORK}/rpmbuild"
mkdir -p "${RPMBUILD}"
cd "${RPMBUILD}" && HOME="${WORK}" rpmbuild --target=$(uname -m) --buildroot "${UNPACKED}" -bb "${SPEC}"

for FILE in $(ls "${WORK}" | egrep -e '\.rpm$')
do
    mv "${WORK}/${FILE}" "${ALIEN_RPM_DIR}"
done
